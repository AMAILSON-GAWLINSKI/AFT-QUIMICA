<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Erros - AFT Qu√≠mica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #2E86C1;
      --danger: #E74C3C;
      --success: #28B463;
      --gray: #F2F2F2;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
    }
    h2 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--primary);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
    }
    #logo {
      max-width: 100px;
      height: auto;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(231, 54, 54, 0.05);
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 10px;
    }
    .form-col {
      flex: 1;
      min-width: 250px;
    }
    label {
      font-weight: bold;
      margin-bottom: 6px;
      display: block;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-primary { background-color: var(--primary); }
    .btn-danger  { background-color: var(--danger); }
    .btn-success { background-color: var(--success); }
    .btn-gray    { background-color: #888; }
    .btn-secondary { background-color: #5A5A5A; }
    .btn:hover { opacity: 0.9; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    th {
      background-color: var(--primary);
      color: white;
      padding: 12px;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td { padding: 10px; border-bottom: 1px solid #ddd; }
    #campoOutro { display: none; }
    /* Estilo para √°rea de resumo */
    #resumo {
      margin-top: 20px;
      padding: 10px;
      background: #eef;
      border-radius: 8px;
    }
    /* Estilo extra para a tabela de resumo */
    #resumo table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
      margin-top: 10px;
      border: 1px solid #ccc;
    }
    #resumo th, #resumo td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    @media (max-width: 768px) {
      .form-col { min-width: 100%; }
    }
  </style>
    <style>
      body { font-family: Arial, sans-serif; background: #ffffff; padding: 20px; }
      .container { background: rgb(247, 247, 247); padding: 30px; max-width: 1000px; margin: auto; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
      h1, h2 { text-align: center; color: #37b61e; }
      .form-group { display: flex; flex-wrap: wrap; gap: 20px; }
      .form-item { flex: 1 1 45%; display: flex; flex-direction: column; }
      label { font-weight: bold; margin-bottom: 5px; }
      input, select, textarea { padding: 10px; border: 1px solid #000000; border-radius: 5px; font-size: 15px; }
      textarea { resize: vertical; }
      button { background-color: #67d320; color: white; padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
      .valor-destaque { background: #dff0d8; color: #000000; padding: 15px; border-radius: 6px; font-size: 22px; text-align: center; margin-top: 20px; }
      .resultado, #historicoContainer { margin-top: 20px; }
      .resultado table, #historicoContainer table { width: 100%; border-collapse: collapse; background: white; }
      table td, table th { padding: 10px; border: 1px solid #000000; text-align: center; }
      th { background: #141414; }
    </style>
</head>
<body>

<h1>
  CONTROLE DE ERROS
</h1>

<!-- Formul√°rio de cadastro -->
<div class="card">
  <div class="form-row">
    <div class="form-col">
      <label>üë∑ Operador:</label>
      <select id="operador">
        <option value="">Selecione um operador</option>
        <option value="Amailson Gawlinski">Amailson Gawlinski</option>
        <option value="Caio Jos√©">Caio Jos√©</option>
        <option value="Daniel Rodrigo">Daniel Rodrigo</option>
        <option value="George Gon√ßalves">George Gon√ßalves</option>
        <option value="Igor Nascimento">Igor Nascimento</option>
        <option value="Lissandro da Silva">Lissandro da Silva</option>
        <option value="Patrick Darlan">Patrick Darlan</option>
        <option value="Ricardo Alves">Ricardo Alves</option>
      </select>
    </div>
    <div class="form-col">
      <label>‚ùå Erro:</label>
      <!-- Op√ß√£o "SEM ERROS" adicionada e demais op√ß√µes fixas -->
      <select id="erro">
        <option value="SEM ERROS">SEM ERROS</option>
        <option value="N√£o avisou o atraso com 30 min. De anteced√™ncia">N√£o avisou o atraso com 30 min. De anteced√™ncia</option>
        <option value="Chegou atrasado na empresa">Chegou atrasado na empresa</option>
        <option value="N√£o usou o produto certo no servi√ßo">N√£o usou o produto certo no servi√ßo</option>
        <option value="N√£o tirou a foto do antes e depois">N√£o tirou a foto do antes e depois</option>
        <option value="N√£o tirou a foto da tampa da caixa">N√£o tirou a foto da tampa da caixa</option>
        <option value="N√£o abriu e fechou a os no hor√°rio certo">N√£o abriu e fechou a os no hor√°rio certo</option>
        <option value="Lan√ßo errado a quantidade de produto no sistema">Lan√ßo errado a quantidade de produto no sistema</option>
        <option value="N√£o lan√ßou o produto no sistema">N√£o lan√ßou o produto no sistema</option>
        <option value="Teve retrabalho de Expugos">Teve retrabalho de Expugos</option>
        <option value="Teve retrabalho de Limpezas">Teve retrabalho de Limpezas</option>
        <option value="Teve retrabalho de dedetiza√ß√£o ou desratiza√ß√£o">Teve retrabalho de dedetiza√ß√£o ou desratiza√ß√£o</option>
        <option value="Teve reclama√ß√£o do cliente">Teve reclama√ß√£o do cliente</option>
        <option value="N√£o est√° uniformizado">N√£o est√° uniformizado</option>
        <option value="N√£o usa EPI adequadamente">N√£o usa EPI adequadamente</option>
        <option value="N√£o cobrou ou n√£o colocou o comprovante de pg no grupo">N√£o cobrou ou n√£o colocou o comprovante de pg no grupo</option>
        <option value="N√£o registrou corertamente a n√£o conformidade">N√£o registrou corertamente a n√£o conformidade</option>
        <option value="N√£o registro na planilha os parametros da piscina">N√£o registro na planilha os parametros da piscina</option>
        <option value="N√£o registrou corretamente o carro no app">N√£o registrou corretamente o carro no app</option>
        <option value="N√£o coletou assinatura no app">N√£o coletou assinatura no app</option>
        <option value="Lan√ßou produto errado">Lan√ßou produto errado</option>
      </select>
    </div>
    <div class="form-col">
      <label>üìÖ Data:</label>
      <input type="date" id="data">
    </div>
    <div class="form-col">
      <label>üîÅ Repetido:</label>
      <select id="repetido">
        <option value="Sim">Sim</option>
        <option value="N√£o">N√£o</option>
      </select>
    </div>
  </div>
  <div class="form-row">
    <!-- Campo para marca√ß√£o espec√≠fica de erro -->
    <div class="form-col">
      <label>Marca de Erro Espec√≠fico:</label>
      <input type="text" id="marcaErro" placeholder="Informe uma marca√ß√£o espec√≠fica (opcional)">
    </div>
  </div>
  <div class="form-row">
    <div class="form-col">
      <label>‚úîÔ∏è Corre√ß√£o:</label>
      <select id="correcao">
        <option value="">Selecione uma corre√ß√£o</option>
        <option value="Treinamento aplicado">Treinamento aplicado</option>
        <option value="Advert√™ncia verbal">Advert√™ncia verbal</option>
        <option value="Refazer tarefa com supervis√£o">Refazer tarefa com supervis√£o</option>
        <option value="Reuni√£o com gestor">Reuni√£o com gestor</option>
        <option value="Outro">Outro</option>
      </select>
      <input type="text" id="campoOutro" placeholder="Descreva a corre√ß√£o personalizada">
    </div>
    <div class="form-col">
      <label>üìù Observa√ß√µes:</label>
      <textarea id="obs" rows="3"></textarea>
    </div>
  </div>
  <div class="form-row">
    <button class="btn btn-success" onclick="adicionarErro()">‚ûï Adicionar</button>
    <!-- Bot√µes de exporta√ß√£o -->
    <button class="btn btn-primary" onclick="exportarPDFFiltro()">üìÑ Exportar PDF (Filtro)</button>
    <button class="btn btn-secondary" onclick="exportarPDFCompleto()">üìÑ Exportar PDF (Completo)</button>
    <button class="btn btn-danger" onclick="limparRegistros()">üßπ Limpar Tudo</button>
  </div>
</div>

<!-- Filtros -->
<div class="card">
  <h3>üîç Filtros</h3>
  <div class="form-row">
    <div class="form-col">
      <select id="filtroOperador">
        <option value="Todos">TODOS os operadores</option>
      </select>
    </div>
    <div class="form-col">
      <input type="date" id="filtroDataInicio">
    </div>
    <div class="form-col">
      <input type="date" id="filtroDataFim">
    </div>
    <div class="form-col">
      <button class="btn btn-primary" onclick="filtrarErros()">Aplicar Filtros</button>
      <!-- Mant√©m o operador selecionado ao limpar datas -->
      <button class="btn btn-gray" onclick="limparDataFiltros()">Limpar Datas</button>
    </div>
  </div>
</div>

<!-- Tabela de registros -->
<table id="tabelaErros">
  <thead>
    <tr>
      <th>Operador</th>
      <th>Erro</th>
      <th>Marca Erro</th>
      <th>Data</th>
      <th>Repetido</th>
      <th>Corre√ß√£o</th>
      <th>Obs</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Resumo dos valores -->
<div id="resumo" class="card">
  <h3>üìà Resumo dos Valores</h3>
  <div id="resumoConteudo"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script>
  let registros = [];
  // Tabela de dedu√ß√µes (valores em reais)
  const deducoes = {
    "N√£o avisou o atraso com 30 min. De anteced√™ncia": 25,
    "Chegou atrasado na empresa": 25,
    "N√£o usou o produto certo no servi√ßo": 50,
    "N√£o tirou a foto do antes e depois": 25,
    "N√£o tirou a foto da tampa da caixa": 25,
    "N√£o abriu e fechou a os no hor√°rio certo": 25,
    "Lan√ßo errado a quantidade de produto no sistema": 25,
    "N√£o lan√ßou o produto no sistema": 50,
    "Teve retrabalho de Expugos": 100,
    "Teve retrabalho de Limpezas": 50,
    "Teve retrabalho de dedetiza√ß√£o ou desratiza√ß√£o": 50,
    "Teve reclama√ß√£o do cliente": 50,
    "N√£o est√° uniformizado": 25,
    "N√£o usa EPI adequadamente": 50,
    "N√£o cobrou ou n√£o colocou o comprovante de pg no grupo": 25,
    "N√£o registrou corertamente a n√£o conformidade": 25,
    "N√£o registro na planilha os parametros da piscina": 25,
    "N√£o registrou corretamente o carro no app": 25,
    "N√£o coletou assinatura no app": 25,
    "Lan√ßou produto errado": 25
  };
  // Cada operador inicia com R$ 300,00
  const baseValor = 300;

  window.onload = () => {
    const salvos = localStorage.getItem("registrosErros");
    if (salvos) {
      registros = JSON.parse(salvos);
      atualizarTabela(registros);
    }
    atualizarFiltroOperadores();
  };

  function salvarLocal() {
    localStorage.setItem("registrosErros", JSON.stringify(registros));
  }

  // Atualiza a tabela e o resumo com base na lista passada
  function atualizarTabela(lista = registros) {
    const tbody = document.querySelector("#tabelaErros tbody");
    tbody.innerHTML = "";
    lista.forEach(r => {
      tbody.innerHTML += `
        <tr>
          <td>${r.operador}</td>
          <td>${r.erro}</td>
          <td>${r.marcaErro || ""}</td>
          <td>${formatarDataBR(r.data)}</td>
          <td>${r.repetido}</td>
          <td>${r.correcao}</td>
          <td>${r.obs}</td>
        </tr>`;
    });
    atualizarFiltroOperadores();
    atualizarResumo(lista);
  }

  function atualizarFiltroOperadores() {
    const selectFiltro = document.getElementById("filtroOperador");
    const operadoresUnicos = [...new Set(registros.map(r => r.operador))].sort();
    selectFiltro.innerHTML = `<option value="Todos">TODOS os operadores</option>`;
    operadoresUnicos.forEach(op => {
      const opt = document.createElement("option");
      opt.value = op;
      opt.textContent = op;
      selectFiltro.appendChild(opt);
    });
  }

  function formatarDataBR(dataISO) {
    const [ano, mes, dia] = dataISO.split("-");
    return `${dia}/${mes}/${ano}`;
  }

  function adicionarErro() {
    const operador = document.getElementById("operador").value;
    const erro = document.getElementById("erro").value;
    const data = document.getElementById("data").value;
    const repetido = document.getElementById("repetido").value;
    let correcao = document.getElementById("correcao").value;
    const campoOutro = document.getElementById("campoOutro");
    if (correcao === "Outro" && campoOutro.value.trim()) {
      correcao = campoOutro.value.trim();
    }
    const obs = document.getElementById("obs").value.trim();
    const marcaErro = document.getElementById("marcaErro").value.trim();

    if (!operador || !erro || !data || !correcao) {
      alert("Preencha todos os campos obrigat√≥rios.");
      return;
    }

    registros.push({ operador, erro, data, repetido, correcao, obs, marcaErro });
    salvarLocal();
    atualizarTabela(registros);
  }

  document.getElementById("correcao").addEventListener("change", function () {
    document.getElementById("campoOutro").style.display = this.value === "Outro" ? "block" : "none";
  });

  function limparRegistros() {
    if (confirm("Apagar todos os registros?")) {
      registros = [];
      localStorage.removeItem("registrosErros");
      atualizarTabela([]);
    }
  }

  function limparDataFiltros() {
    document.getElementById("filtroDataInicio").value = "";
    document.getElementById("filtroDataFim").value = "";
    filtrarErros();
  }

  function filtrarErros() {
    const filtroOperador = document.getElementById("filtroOperador").value;
    const inicio = document.getElementById("filtroDataInicio").value;
    const fim = document.getElementById("filtroDataFim").value;
    let filtrados = registros;
    if (filtroOperador !== "Todos") {
      filtrados = filtrados.filter(r => r.operador === filtroOperador);
    }
    filtrados = filtrados.filter(r => (!inicio || r.data >= inicio) && (!fim || r.data <= fim));
    atualizarTabela(filtrados);
  }

  // Atualiza o resumo exibido na p√°gina
  function atualizarResumo(lista = registros) {
    const resumoOp = {};
    lista.forEach(r => {
      const op = r.operador;
      if (!resumoOp[op]) {
        resumoOp[op] = { totalErros: 0, desconto: 0 };
      }
      resumoOp[op].totalErros++;
      // Se o erro for "SEM ERROS" nenhum desconto √© aplicado
      if (r.erro !== "SEM ERROS" && deducoes[r.erro] !== undefined) {
        resumoOp[op].desconto += deducoes[r.erro];
      }
    });
    for (let op in resumoOp) {
      resumoOp[op].valorFinal = Math.max(0, baseValor - resumoOp[op].desconto);
    }
    // Monta o HTML do resumo com alinhamento centralizado e linhas definidas
    let html = "<h4>Resumo por Operador</h4>";
    html += `<table>
      <thead>
        <tr style="background-color: var(--primary); color: white;">
          <th>Operador</th>
          <th>Total de Erros</th>
          <th>Total Descontado (R$)</th>
          <th>Valor Final (R$)</th>
        </tr>
      </thead>
      <tbody>`;
    for (let op in resumoOp) {
      const item = resumoOp[op];
      html += `<tr>
        <td>${op}</td>
        <td>${item.totalErros}</td>
        <td>${item.desconto.toFixed(2)}</td>
        <td style="font-weight: bold; color: var(--success);">R$ ${item.valorFinal.toFixed(2)}</td>
      </tr>`;
    }
    html += "</tbody></table>";

    // Se houver filtro por data, acrescenta o resumo dos erros cometidos
    const inicio = document.getElementById("filtroDataInicio").value;
    const fim = document.getElementById("filtroDataFim").value;
    if (inicio || fim) {
      const resumoErros = {};
      lista.forEach(r => {
        const erro = r.erro;
        if (!resumoErros[erro]) {
          resumoErros[erro] = 0;
        }
        resumoErros[erro]++;
      });
      html += "<h4 style='margin-top:20px;'>Resumo de Erros Cometidos</h4>";
      html += `<table>
        <thead>
          <tr style="background-color: var(--primary); color: white;">
            <th>Erro</th>
            <th>Quantidade</th>
          </tr>
        </thead>
        <tbody>`;
      for (let erro in resumoErros) {
        html += `<tr>
          <td>${erro}</td>
          <td>${resumoErros[erro]}</td>
        </tr>`;
      }
      html += "</tbody></table>";
    }
    document.getElementById("resumoConteudo").innerHTML = html;
  }

  // Exporta√ß√£o em PDF (Filtro e Completo)
  async function exportarPDFFiltro() {
    const filtroOperador = document.getElementById("filtroOperador").value;
    if (filtroOperador === "Todos") {
      alert("Selecione um operador espec√≠fico para exportar o PDF filtrado.");
      return;
    }
    const inicio = document.getElementById("filtroDataInicio").value;
    const fim = document.getElementById("filtroDataFim").value;
    const dados = registros.filter(r => {
      return r.operador === filtroOperador &&
             (!inicio || r.data >= inicio) &&
             (!fim || r.data <= fim);
    });
    gerarPDF(dados, `Relat√≥rio de Erros (${filtroOperador})`);
  }

  async function exportarPDFCompleto() {
    gerarPDF(registros, "Relat√≥rio de Erros (Completo)");
  }

  async function gerarPDF(dados, titulo) {
    if (!dados.length) {
      alert("N√£o h√° registros para exportar.");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text(titulo, 14, 15);

    // Tabela de registros
    const headers = [["Operador", "Erro", "Marca Erro", "Data", "Repetido", "Corre√ß√£o", "Obs"]];
    const dataTabela = dados.map(r => {
      const [ano, mes, dia] = r.data.split("-");
      const dataBR = `${dia}/${mes}/${ano}`;
      return [r.operador, r.erro, r.marcaErro || "", dataBR, r.repetido, r.correcao, r.obs];
    });
    doc.autoTable({
      head: headers,
      body: dataTabela,
      startY: 25,
      theme: "striped",
      headStyles: { fillColor: [46, 134, 193] }
    });

    // Gera√ß√£o do resumo para PDF
    const resumoObj = gerarResumoPDF(dados);
    let resumoPDF = "Resumo dos Valores:\n\n";
    resumoPDF += "Operador | Erros | Total Descontado (R$) | Valor Final (R$)\n";
    resumoPDF += "-------------------------------------------------------------\n";
    for (let op in resumoObj.operadores) {
      const item = resumoObj.operadores[op];
      resumoPDF += `${op} | ${item.totalErros} | ${item.desconto.toFixed(2)} | ${item.valorFinal.toFixed(2)}\n`;
    }
    if (resumoObj.erros) {
      resumoPDF += "\nResumo de Erros Cometidos:\n";
      resumoPDF += "Erro | Quantidade\n";
      resumoPDF += "--------------------\n";
      for (let erro in resumoObj.erros) {
        resumoPDF += `${erro} | ${resumoObj.erros[erro]}\n`;
      }
    }
    doc.addPage();
    doc.setFontSize(12);
    doc.text(resumoPDF, 14, 15);
    
    doc.save(`${titulo.replace(/\s/g, '_')}.pdf`);
  }
  
  // Fun√ß√£o que gera os dados resumo para o PDF
  function gerarResumoPDF(dados) {
    const operadores = {};
    const erros = {};
    dados.forEach(r => {
      const op = r.operador;
      if (!operadores[op]) { operadores[op] = { totalErros: 0, desconto: 0 }; }
      operadores[op].totalErros++;
      if (r.erro !== "SEM ERROS" && deducoes[r.erro] !== undefined) {
        operadores[op].desconto += deducoes[r.erro];
      }
      if (!erros[r.erro]) { erros[r.erro] = 0; }
      erros[r.erro]++;
    });
    for (let op in operadores) {
      operadores[op].valorFinal = Math.max(0, baseValor - operadores[op].desconto);
    }
    return { operadores, erros };
  }
</script>

</body>
</html>
